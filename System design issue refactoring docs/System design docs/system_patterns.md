# System Design Patterns Analysis

This document outlines the software design patterns implemented within the Course Platform architecture. It maps standard patterns to specific code artifacts to aid in understanding the system's structure and behavior.

## 1. Creational Patterns

### 1.1 Singleton Pattern
**Descrition**: Ensures a class has only one instance and provides a global point of access to it.
**Implementation**: Database Connection (`PrismaClient`).
-   **File**: `backend/src/services/prisma.ts`
-   **Context**: The application initializes a single instance of `PrismaClient` and attaches it to the `global` object in non-production environments to prevent connection exhaustion during hot-reloads.
-   **Code Evidence**:
    ```typescript
    const prismaClient = global.prisma ?? new PrismaClient({ ... });
    if (env.nodeEnv !== "production") global.prisma = prismaClient;
    export const prisma = prismaClient;
    ```

## 2. Structural Patterns

### 2.1 Facade Pattern
**Description**: Provides a simplified interface to a library, a framework, or any other complex set of classes.
**Implementation**:
1.  **API Client**: `frontend/src/lib/api.ts`
    -   **Context**: Hides the complexity of Base URL configuration and environment variable resolution from the rest of the frontend application. Components just call `buildApiUrl("/path")` without worrying about `localhost` vs production domains.
2.  **Service Layer**: `backend/src/services/*`
    -   **Context**: Services like `jobQueueService` provide high-level methods (`enqueueJob`, `claimNextJob`) that abstract away the complex raw SQL queries and row locking mechanisms required to operate the queue.

### 2.2 Adapter Pattern (Implicit)
**Description**: Allows objects with incompatible interfaces to collaborate.
**Implementation**: Video URL Normalization.
-   **Files**: `backend/src/routes/lessons.ts` & `frontend/src/pages/CoursePlayerPage.tsx`
-   **Context**: The `normalizeVideoUrl` function acts as an adapter, taking various distinct YouTube URL formats (Shorts, Embeds, Watch) and adapting them into a single, standardized format required by the embed player.

## 3. Behavioral Patterns

### 3.1 Chain of Responsibility
**Description**: Passes requests along a chain of handlers. Upon receiving a request, each handler decides either to process the request or to pass it to the next handler in the chain.
**Implementation**: Express Middleware.
-   **File**: `backend/src/middleware/requireAuth.ts`
-   **Context**: The `requireAuth` function intercepts HTTP requests.
    1.  Checks for `Authorization` header.
    2.  Verifies JWT token.
    3.  If valid, attaches user context to `req` and calls `next()`.
    4.  If invalid, terminates the chain with a 401 response.

### 3.2 Command Pattern (Producer-Consumer)
**Description**: Encapsulates a request as an object, thereby letting you parameterize clients with different requests, queue or log requests, and support undoable operations.
**Implementation**: Asynchronous Job Queue.
-   **File**: `backend/src/services/jobQueueService.ts`
-   **Context**:
    -   **Invoker**: API Routes (e.g., `/assistant/query`).
    -   **Command**: A serialized JSON object stored in the `background_jobs` table (`job_type`, `payload`).
    -   **Receiver**: The Worker process.
    -   **Mechanism**: The `enqueueJob` function encapsulates the intent (e.g., "Run RAG Query") into a persistent command row. The worker later claims and executes this command.

### 3.3 Observer Pattern
**Description**: Lets you define a subscription mechanism to notify multiple objects about any events that happen to the object they're observing.
**Implementation**: Server-Sent Events (SSE).
-   **File**: `backend/src/routes/assistant.ts`
-   **Context**:
    -   **Subject**: The Backend Job status.
    -   **Observer**: The Frontend Client.
    -   **Mechanism**: The client opens a persistent connection (`/stream/:jobId`). The server pushes updates ("Observer notification") whenever the job status changes or new tokens are generated by the LLM.

### 3.4 Strategy Pattern
**Description**: Defines a family of algorithms, puts each of them into a separate class, and makes their objects interchangeable.
**Implementation**: Content Resolution Strategy.
-   **File**: `backend/src/routes/lessons.ts` / `backend/src/services/courseResolutionService.ts`
-   **Context**: The system renders course content differently based on the user's "Persona".
    -   **Strategies**: "Default", "Sports-Analogy", "Cooking-Analogy".
    -   **Execution**: The resolution logic checks the `personaKey` and swaps out content blocks implementation dynamically at runtime without changing the core content delivery loop.
